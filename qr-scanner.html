<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#4CAF50">
    <title>QRç¢¼æƒæå™¨</title>
    <script src="https://unpkg.com/html5-qrcode/minified/html5-qrcode.min.js"></script>
    <style>
        body { 
            font-family: Arial, sans-serif; 
            padding: 10px; 
            text-align: center; 
            background: #000;
            margin: 0;
        }
        .container {
            max-width: 100%;
            margin: 0 auto;
            background: #000;
            padding: 10px;
        }
        h1 { color: white; font-size: 18px; margin: 10px 0; }
        #qr-reader { 
            width: 100%; 
            max-width: 400px; 
            margin: 0 auto;
        }
        button { 
            padding: 12px 20px; 
            font-size: 16px; 
            background: #f44336; 
            color: white; 
            border: none; 
            border-radius: 5px; 
            margin: 10px;
            cursor: pointer;
        }
        button:hover { background: #da190b; }
        .status { 
            color: white; 
            margin: 10px 0; 
            font-size: 14px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ“± QRç¢¼æƒæå™¨</h1>
        <div class="status" id="status">æ­£åœ¨å•Ÿå‹•ç›¸æ©Ÿ...</div>
        <div id="qr-reader"></div>
        <button onclick="goBack()">è¿”å›ä¸»é é¢</button>
    </div>

    <script>
        let html5QrCode = null;
        
        function startScanner() {
            const statusDiv = document.getElementById('status');
            
            try {
                html5QrCode = new Html5Qrcode("qr-reader");
                
                const config = {
                    fps: 10,
                    qrbox: function(viewfinderWidth, viewfinderHeight) {
                        const minEdge = Math.min(viewfinderWidth, viewfinderHeight);
                        const qrboxSize = Math.floor(minEdge * 0.8);
                        return {
                            width: qrboxSize,
                            height: qrboxSize
                        };
                    }
                };
                
                statusDiv.textContent = 'è«‹å°‡QRç¢¼å°æº–æƒææ¡†...';
                
                html5QrCode.start(
                    { facingMode: "environment" },
                    config,
                    onScanSuccess,
                    onScanFailure
                ).catch(err => {
                    console.error('å¾Œç½®ç›¸æ©Ÿå¤±æ•—:', err);
                    statusDiv.textContent = 'å˜—è©¦å‰ç½®ç›¸æ©Ÿ...';
                    
                    html5QrCode.start(
                        { facingMode: "user" },
                        config,
                        onScanSuccess,
                        onScanFailure
                    ).catch(err2 => {
                        console.error('æ‰€æœ‰ç›¸æ©Ÿéƒ½å¤±æ•—:', err2);
                        statusDiv.textContent = 'ç„¡æ³•å•Ÿå‹•ç›¸æ©Ÿï¼Œè«‹æª¢æŸ¥æ¬Šé™è¨­å®š';
                    });
                });
                
            } catch (error) {
                console.error('åˆå§‹åŒ–éŒ¯èª¤:', error);
                statusDiv.textContent = 'æƒæå™¨åˆå§‹åŒ–å¤±æ•—';
            }
        }
        
        function onScanSuccess(decodedText) {
            console.log('æƒææˆåŠŸ:', decodedText);
            
            // åœæ­¢æƒæ
            if (html5QrCode) {
                html5QrCode.stop();
            }
            
            // è™•ç†æƒæçµæœ
            let locationId = decodedText;
            if (decodedText.includes('location=')) {
                try {
                    const urlParams = new URLSearchParams(decodedText.split('?')[1]);
                    locationId = decodeURIComponent(urlParams.get('location'));
                } catch (e) {
                    locationId = decodedText;
                }
            }
            
            // è¿”å›ä¸»é é¢ä¸¦å‚³éçµæœ
            const mainPageUrl = window.location.href.replace('qr-scanner.html', 'cleaning_simple.html');
            window.location.href = mainPageUrl + '?location=' + encodeURIComponent(locationId);
        }
        
        function onScanFailure(error) {
            // æƒæå¤±æ•—æ™‚ä¸åšä»»ä½•äº‹ï¼Œç¹¼çºŒæƒæ
        }
        
        function goBack() {
            if (html5QrCode) {
                html5QrCode.stop();
            }
            const mainPageUrl = window.location.href.replace('qr-scanner.html', 'cleaning_simple.html');
            window.location.href = mainPageUrl;
        }
        
        // é é¢è¼‰å…¥å¾Œè‡ªå‹•å•Ÿå‹•æƒæ
        window.addEventListener('load', () => {
            setTimeout(startScanner, 500);
        });
        
        // é˜²æ­¢é é¢æ„å¤–é—œé–‰
        window.addEventListener('beforeunload', () => {
            if (html5QrCode) {
                html5QrCode.stop();
            }
        });
    </script>
</body>
</html>